#!/system/bin/sh
echo "TKSGB zram settings manager"

# Includes
. /sbin/lib.sh

# Defines
ZRAM_SIZE=50331648
# 48MB in bytes

# Paths
ZRAM_SCRIPT=/system/etc/init.d/05zram

# Functions
show_zram() {
echo "
Displaying current zram status:

zram is compressed swap; numbers are in KB

             total         used         free"
free | tail -1
echo ""
}

write_zram() {
echo "#!/system/bin/sh
if [ -e /dev/block/zram0 ]; then
	echo 1 > /sys/block/zram0/reset
	echo $1 > /sys/block/zram0/disksize
	mkswap /dev/block/zram0
	swapon /dev/block/zram0
fi" > $2
chown 0.0 $2
chmod 755 $2
}

if [ -e /dev/block/zram0 ]; then
	if [ $1 ]; then
		if [ $1 == "enable" ]; then
			echo "Enabling zram."

			( system_rw &&							\
				write_zram $ZRAM_SIZE $ZRAM_SCRIPT &&			\
				system_ro &&						\
				echo "Boot script installed." )				\
			||								\
			( echo "Boot script could not be installed!" &&			\
				exit )

			( $INITSCRIPT_PATH &&						\
				echo "zram enabled." )					\
			||								\
			( echo "zram could not be enabled!" &&				\
				exit )
		elif [ $1 == "disable" ]; then
			echo "Disabling zram."

			( swapoff /dev/block/zram0 >/dev/null 2>&1 &&			\
				echo 1 > /sys/block/zram0/reset >/dev/null 2>&1 &&	\
				echo "zram disabled." )					\
			||								\
			( echo "zram could not be disabled!" &&				\
				exit )

			if `fexist $ZRAM_SCRIPT`; then
				( system_rw &&						\
					rm $ZRAM_SCRIPT &&				\
					system_ro &&					\
					echo "Boot script removed." )			\
				||							\
				( echo "Boot script could not be removed!" &&		\
					exit )
			else
				echo "Boot script not found. No need to remove."
			fi
		elif [ $1 == "show" ]; then
			show_zram
		else
			echo "Unrecognized option."
			show_options "zram"
		fi
	else
	show_options "zram"
	fi
else
echo "Kernel does not support zram."
fi
