#!/system/bin/sh
echo "zram settings manager"
echo ""

# Get RAM size in KB
RAMSIZE=`grep MemTotal /proc/meminfo | awk '{ print \$2 }'`
# zram size is set in bytes; 1024 * 12.5% = 128
ZRAMSIZE=$(($RAMSIZE*128))
INITSCRIPT_PATH=/system/etc/init.d/05zram

show_options()
{
echo "Usage: zram [OPTION]"
echo "Valid options:"
echo ""
echo "  enable    Install boot script"
echo "            Enable zram"
echo "  disable   Remove boot script"
echo "            Disable zram"
echo "  show      Show current status"
echo ""
echo "Example: zram show"
echo ""
}

show_status()
{
echo "Current status:"
echo ""
echo "zram is compressed swap; numbers are in KB"
echo ""
echo "             total         used         free"
free | tail -1
echo ""
}

write_initscript()
{
echo "#!/system/bin/sh" > $2
echo "echo 1 > /sys/block/zram0/reset" >> $2
echo "echo $1 > /sys/block/zram0/disksize" >> $2
echo "mkswap /dev/block/zram0" >> $2
echo "swapon /dev/block/zram0" >> $2
chown 0:0 $2
chmod 755 $2
}

mount_system_rw()
{
mount -o rw,remount /system /system
}

mount_system_ro()
{
mount -o ro,remount /system /system
}

if [ -e /dev/block/zram0 ]; then
	if [ $1 ]; then
		if [ $1 == "enable" ]; then
			mount_system_rw
			write_initscript $ZRAMSIZE $INITSCRIPT_PATH
			mount_system_ro
			echo "Boot script installed."

			$INITSCRIPT_PATH
			echo "zram enabled."

			echo ""
		elif [ $1 == "disable" ]; then
			swapoff /dev/block/zram0 >/dev/null 2>&1
			echo 1 > /sys/block/zram0/reset >/dev/null 2>&1
			echo "zram disabled."

			if [ -e $INITSCRIPT_PATH ]; then
				mount_system_rw
				rm $INITSCRIPT_PATH
				mount_system_ro
				echo "Boot script removed."
			else
				echo "Boot script not found. No need to remove."
			fi
			mount_system_ro

			echo ""
		elif [ $1 == "show" ]; then
			show_status
		else
			echo "Unrecognized option."
			echo ""
			show_options
		fi
	else
	show_options
	fi
else
echo "Kernel does not support zram."
fi
