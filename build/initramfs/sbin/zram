#!/system/bin/sh
echo "TKSGB zram manager"

# Includes
. /sbin/lib.sh

# Defines
ZRAM_SIZE=50331648
# 48MB in bytes

# Paths
ZRAM_SCRIPT=/system/etc/init.d/05zram

# Functions
show_zram()
{
echo "
Displaying current zram status:

zram is compressed swap; numbers are in KB

             total         used         free"
free | tail -1
echo ""
}

write_zram()
{
system_rw
echo "#!/system/bin/sh
if [ -e /sys/block/zram0 ]; then
	echo 1 > /sys/block/zram0/reset
	echo $1 > /sys/block/zram0/disksize
	mkswap /dev/block/zram0
	swapon /dev/block/zram0
fi" > $2
chown 0.0 $2
chmod 755 $2
system_ro
}

off_zram()
{
swapoff /dev/block/zram0 >/dev/null 2>&1 &&
echo 1 > /sys/block/zram0/reset >/dev/null 2>&1
}

remove_zram()
{
system_rw
rm $ZRAM_SCRIPT 2>&1
system_ro
}

if [ -e /dev/block/zram0 ]; then
	if [ $1 ]; then
		if [ $1 == "enable" ]; then
			echo "Enabling zram."

			( write_zram $ZRAM_SIZE $ZRAM_SCRIPT && echo "Boot script installed." ) || \
				echo "Boot script could not be installed!"

			( $ZRAM_SCRIPT && echo "zram enabled." ) || \
				echo "zram could not be enabled!"

		elif [ $1 == "disable" ]; then
			echo "Disabling zram."

			( off_zram && echo "zram disabled." ) || \
				echo "zram could not be disabled!"

			if `fexist $ZRAM_SCRIPT`; then
				( remove_zram && echo "Boot script removed." ) || \
					echo "Boot script could not be removed!"
			else
				echo "Boot script not found. No need to remove."
			fi
		elif [ $1 == "show" ]; then
			show_zram
		else
			echo "Unrecognized option!"
			show_options "zram"
		fi
	else
	show_options "zram"
	fi
else
echo "Kernel does not support zram."
fi
