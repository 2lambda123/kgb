#!/system/bin/sh
echo "KGB in-call boost settings manager"

# Includes
. /sbin/lib.sh

# Paths
BOOST_RCV=/sys/devices/virtual/misc/voodoo_sound/incall_boost_rcv
BOOST_BT=/sys/devices/virtual/misc/voodoo_sound/incall_boost_bt
BOOST_SPK=/sys/devices/virtual/misc/voodoo_sound/incall_boost_spk
BOOST_HP=/sys/devices/virtual/misc/voodoo_sound/incall_boost_hp
BOOST_SCRIPT=/system/etc/init.d/91callboost

# Functions
show_boost()
{
echo "
Displaying current in-call boost settings:

	RCV	BT	SPK	HP
	$B_RCV	$B_BT	$B_SPK	$B_HP

    0: +0dB, 1: +6dB, 2: +12dB, 3: +18dB
"
}

read_boost()
{
B_RCV=`cat $BOOST_RCV`
B_BT=`cat $BOOST_BT`
B_SPK=`cat $BOOST_SPK`
B_HP=`cat $BOOST_HP`
}

set_boost()
{
echo $1 > $BOOST_RCV
echo $2 > $BOOST_BT
echo $3 > $BOOST_SPK
echo $4 > $BOOST_HP
}

write_boost()
{
echo "#!/system/bin/sh
echo $B_RCV > $BOOST_RCV
echo $B_BT > $BOOST_BT
echo $B_SPK > $BOOST_SPK
echo $B_HP > $BOOST_HP" > $BOOST_SCRIPT
chown 0.0 $BOOST_SCRIPT
chmod 755 $BOOST_SCRIPT
}

if `fexist $BOOST_RCV $BOOST_BT $BOOST_SPK $BOOST_HP`; then
	read_boost
	if [ $1 ]; then
		if [ $1 == "enable" ]; then
			show_boost

			echo "    Recommended: 1 or 2, 0, 0, 0 or 1"
			echo ""
			echo -n "    New RECEIVER boost value:	"
			read B_RCV
			echo -n "    New BLUETOOTH boost value:	"
			read B_BT
			echo -n "    New SPEAKER boost value:	"
			read B_SPK
			echo -n "    New HEADPHONE boost value:	"
			read B_HP
			echo ""

			( set_boost $B_RCV $B_BT $B_SPK $B_HP &&			\
				echo "In-call boost values set." )			\
			||								\
			( echo "In-call boost values could not be set!" &&		\
				exit )

			( system_rw &&							\
				write_boost &&						\
				system_ro &&						\
				echo "Boot script installed." )				\
			||								\
			( echo "Boot script could not be installed!" &&			\
				exit )

			show_boost
		elif [ $1 == "disable" ]; then
			show_boost

			( set_boost 0 0 0 0 &&						\
				echo "In-call boost values reset to defaults." )	\
			||
			( echo "In-call boost values could not be reset!" &&		\
				exit )

			if `fexist $BOOST_SCRIPT`; then
				( system_rw &&						\
					rm $BOOST_SCRIPT &&				\
					system_ro &&					\
					echo "Boot script removed." )			\
				||							\
				( echo "Boot script could not be removed!" &&		\
					exit )
			else
				echo "Boot script not found. No need to remove."
			fi

			show_boost
		elif [ $1 == "show" ]; then
			show_boost
		else
			echo "Unrecognized option."
			show_options "callboost"
		fi
	else
		show_options "callboost"
	fi
else
echo "Kernel does not support in-call boost settings."
fi
